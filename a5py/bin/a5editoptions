#!/usr/bin/env python3


import a5py.ascot5io.options     as options
import a5py.ascot5io.ascot5      as ascot5
import a5py.ascot5io.ascot5tools as tools
import numpy
import os
import subprocess
import sys
import tempfile

if len(sys.argv) > 1:
    fn = sys.argv[1]
else:
    fn = "ascot.h5"

qid = tools.call_ascot5file(fn, "get_activeqid", "options")
print(qid)
opt = options.read_hdf5(fn, qid)
opt.pop('qid')
opt.pop('date')
opt.pop('description')

t = ""
for k,v in sorted(opt.items()):
    if(len(v) == 1):
        t = t + k + "=" + str(v[0]) + "\n"
    elif(len(v) > 1):
        t = t + k + "=" + ",".join([str(vv) for vv in v]) + "\n"

f,tmpfn = tempfile.mkstemp()
f=os.fdopen(f,'w')
f.write(t)
f.close()

ed=os.environ.get('EDITOR','vim')
subprocess.call([ed,tmpfn])

f=open(tmpfn)
lines=f.readlines()
f.close()
os.remove(tmpfn)

opt.clear()
for line in lines:
    p = line.split("=")
    if(len(p)==2):
        opt[p[0].strip()] = numpy.fromstring(p[1].strip(),sep=",")

group = options.write_hdf5(fn, opt)
tools.call_ascot5file(fn, "set_active", group)
print("Options set and set as active.")
