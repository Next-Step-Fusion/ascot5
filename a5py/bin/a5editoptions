#!/usr/bin/env python

import a5py.ascot5io.options as options
import a5py.ascot5io.ascot5 as ascot5
import numpy
import os
import subprocess
import sys
import tempfile

if len(sys.argv) > 1:
    fn = sys.argv[1]
else:
    fn = "ascot.h5"

qids,dates = ascot5.get_qids(fn, "options")
opt = options.read_hdf5(fn, qids[0])
opt.pop('qid')
opt.pop('date')
opt.pop('description')

t = ""
for k,v in sorted(opt.items()):
    if(len(v) == 1):
        t = t + k + "=" + str(v[0]) + "\n"
    elif(len(v) > 1):
        t = t + k + "=" + ",".join([str(vv) for vv in v]) + "\n"

f,tmpfn = tempfile.mkstemp()
f=os.fdopen(f,'w')
f.write(t)
f.close()

ed=os.environ.get('EDITOR','vi')
subprocess.call([ed,tmpfn]) 

f=open(tmpfn)
lines=f.readlines()
f.close()
os.remove(tmpfn)

opt.clear()
for line in lines:
    p = line.split("=")
    if(len(p)==2):
        opt[p[0].strip()] = numpy.fromstring(p[1].strip(),sep=",")

options.write_hdf5(fn, opt)
print("Options set.")
